
{% extends 'base.html' %}
{% block content %}
  <div class="d-flex align-items-center mb-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="autoSwitch" {{ 'checked' if auto_refresh else '' }}>
      <label class="form-check-label" for="autoSwitch">Auto (1 min)</label>
    </div>
  </div>

  <form class="row row-cols-lg-auto g-2 mb-3" method="get" action="{{ url_for('dashboard') }}">
    <div class="col">
      <label class="form-label">Race ID</label>
      <input type="number" name="race_id" class="form-control" value="{{ race_id }}">
    </div>
    <div class="col d-flex align-items-end">
      <button class="btn btn-primary" type="submit">Atualizar</button>
    </div>
  </form>

  <div class="table-responsive mb-4">
    <table class="table table-striped table-hover table-sm align-middle">
      <thead>
        <tr>
          <th>Racer ID</th>
          <th>Nº</th>
          <th>Nome</th>
          <th>Última volta</th>
          <th colspan="5" class="text-center">Últimas 5 voltas</th>
          <th>Média 5</th>
          <th>Média 10</th>
        </tr>
      </thead>
      <tbody>
        {% for r in main_rows %}
          <tr>
            <td>{{ r.racer_id }}</td>
            <td>{{ r.number }}</td>
            <td>{{ r.first_name }} {{ r.last_name }}</td>
            {% set base_avg = global_avg_ms %}
            {% set last_ms = r.last_lap_ms %}
            {% set delta = (last_ms - base_avg) if (last_ms is not none and base_avg is not none) else none %}
            <td class="{{ get_color_class(delta) }}">{% if r.last_lap_ms is not none %}{{ fmt_ms(r.last_lap_ms) }}{% else %}—{% endif %}</td>
            {% for lap in r.last5_ms %}
              {% set d5 = (lap - base_avg) if (lap is not none and base_avg is not none) else none %}
              <td class="{{ get_color_class(d5) }}">{% if lap is not none %}{{ fmt_ms(lap) }}{% else %}—{% endif %}</td>
            {% endfor %}
            {% for i in range(5 - (r.last5_ms|length)) %}
              <td>—</td>
            {% endfor %}
            <td>{% if r.avg5_ms is not none %}{{ fmt_ms(r.avg5_ms) }}{% else %}—{% endif %}</td>
            <td>{% if r.avg10_ms is not none %}{{ fmt_ms(r.avg10_ms) }}{% else %}—{% endif %}</td>
          </tr>
        {% endfor %}
        {% if main_rows|length == 0 %}
          <tr><td colspan="12" class="text-center text-muted">Sem dados para os karts principais.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div class="table-responsive mb-4">
    <table class="table table-striped table-hover table-sm align-middle">
      <thead>
        <tr>
          <th>Pos</th>
          <th>Racer ID</th>
          <th>Nº</th>
          <th>Nome</th>
          <th>Última volta</th>
          <th colspan="5" class="text-center">Últimas 5 voltas</th>
          <th>Média 5</th>
          <th>Média 10</th>
        </tr>
      </thead>
      <tbody>
        {% for r in pos_rows %}
          <tr>
            <td>{{ r.position }}</td>
            <td>{{ r.racer_id }}</td>
            <td>{{ r.number }}</td>
            <td>{{ r.first_name }} {{ r.last_name }}</td>
            <td>{% if r.last_lap_ms is not none %}{{ fmt_ms(r.last_lap_ms) }}{% else %}—{% endif %}</td>
            {% for lap in r.last5_ms %}
              <td>{% if lap is not none %}{{ fmt_ms(lap) }}{% else %}—{% endif %}</td>
            {% endfor %}
            {% for i in range(5 - (r.last5_ms|length)) %}
              <td>—</td>
            {% endfor %}
            <td>{% if r.avg5_ms is not none %}{{ fmt_ms(r.avg5_ms) }}{% else %}—{% endif %}</td>
            <td>{% if r.avg10_ms is not none %}{{ fmt_ms(r.avg10_ms) }}{% else %}—{% endif %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">5 mais rápidas (última volta)</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>Nº</th><th>Nome</th><th>Última</th></tr></thead>
              <tbody>
                {% for r in fastest_rows %}
                  {% if r %}
                  <tr>
                    <td>{{ r.number }}</td>
                    <td>{{ r.first_name }} {{ r.last_name }}</td>
                    <td>{% if r.last_lap_ms is not none %}{{ fmt_ms(r.last_lap_ms) }}{% else %}—{% endif %}</td>
                  </tr>
                  {% endif %}
                {% endfor %}
                {% if fastest_rows|length == 0 %}
                  <tr><td colspan="3" class="text-center text-muted">Sem dados.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">5 mais lentas (última volta) – ignora > 1:30</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>Nº</th><th>Nome</th><th>Última</th></tr></thead>
              <tbody>
                {% for r in slowest_rows %}
                  {% if r %}
                  <tr>
                    <td>{{ r.number }}</td>
                    <td>{{ r.first_name }} {{ r.last_name }}</td>
                    <td>{% if r.last_lap_ms is not none %}{{ fmt_ms(r.last_lap_ms) }}{% else %}—{% endif %}</td>
                  </tr>
                  {% endif %}
                {% endfor %}
                {% if slowest_rows|length == 0 %}
                  <tr><td colspan="3" class="text-center text-muted">Sem dados.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <strong>Média da última volta (todas equipes, ignora > 2:00):</strong>
      {% if avg_last_ms is not none %}{{ fmt_ms(avg_last_ms) }}{% else %}—{% endif %}
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Selecionar karts específicos (vários)</div>
    <div class="card-body">
      <form class="row g-2" method="get" action="{{ url_for('dashboard') }}">
        <input type="hidden" name="race_id" value="{{ race_id }}">
        <div class="col-md-6">
          <label class="form-label">Karts (separados por vírgula)</label>
          <input type="text" name="kart_numbers" class="form-control" value="{{ chosen_numbers }}" placeholder="ex.: 21, 34, 7">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-primary" type="submit">Mostrar</button>
        </div>
      </form>
      {% if chosen_rows and chosen_rows|length > 0 %}
      <div class="table-responsive mt-3">
        <table class="table table-striped table-hover table-sm align-middle">
          <thead>
            <tr>
              <th>Racer ID</th><th>Nº</th><th>Nome</th><th>Última volta</th>
              <th colspan="5" class="text-center">Últimas 5 voltas</th>
              <th>Média 5</th><th>Média 10</th>
            </tr>
          </thead>
          <tbody>
            {% for r in chosen_rows %}
            <tr>
              <td>{{ r.racer_id }}</td>
              <td>{{ r.number }}</td>
              <td>{{ r.first_name }} {{ r.last_name }}</td>
              <td>{% if r.last_lap_ms is not none %}{{ fmt_ms(r.last_lap_ms) }}{% else %}—{% endif %}</td>
              {% for lap in r.last5_ms %}
                <td>{% if lap is not none %}{{ fmt_ms(lap) }}{% else %}—{% endif %}</td>
              {% endfor %}
              {% for i in range(5 - (r.last5_ms|length)) %}
                <td>—</td>
              {% endfor %}
              <td>{% if r.avg5_ms is not none %}{{ fmt_ms(r.avg5_ms) }}{% else %}—{% endif %}</td>
              <td>{% if r.avg10_ms is not none %}{{ fmt_ms(r.avg10_ms) }}{% else %}—{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

  <script>
    function reloadWithAuto(on) {
      const url = new URL(window.location.href);
      url.searchParams.set('auto', on ? 'on' : 'off');
      window.location.href = url.toString();
    }
    const autoSwitch = document.getElementById('autoSwitch');
    if (autoSwitch) {
      autoSwitch.addEventListener('change', () => reloadWithAuto(autoSwitch.checked));
      if (autoSwitch.checked) { setInterval(() => { window.location.reload(); }, 60000); }
    }
  </script>
{% endblock %}
